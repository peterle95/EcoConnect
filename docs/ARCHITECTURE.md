# EcoConnect Architecture and Integration Guide

This document explains the files created during the Auth + DB integration work, and how the backend, frontend, and database interact. It also outlines recommended next steps.

## Repository Layout
Root directory: `./` (@[.])

- `backend/` — NestJS API server (Auth, Prisma, Config)
- `docs/` — Project documentation (`DATABASE.md`, this `ARCHITECTURE.md`)
- `backend/prisma/` — Prisma schema and migrations

## Files Created/Updated

### Backend: NestJS
- `backend/src/app.module.ts` (updated)
  - Wires `ConfigModule`, `PrismaModule`, and `AuthModule`.
- `backend/src/main.ts` (updated)
  - Enables global `ValidationPipe` (class-validator) and integrates Prisma shutdown hooks.

#### Prisma
- `backend/src/prisma/prisma.module.ts` (created)
  - Exposes a singleton `PrismaService` for dependency injection across modules.
- `backend/src/prisma/prisma.service.ts` (created/updated)
  - Extends `PrismaClient`; connects on module init.
  - Uses `process.on('beforeExit')` to gracefully close the Nest app.

#### Auth
- `backend/src/auth/auth.module.ts` (created)
  - Imports `JwtModule`, `PassportModule`; provides `AuthService`, `JwtStrategy`.
- `backend/src/auth/auth.controller.ts` (created)
  - REST endpoints: `POST /auth/signup`, `POST /auth/login`.
- `backend/src/auth/auth.service.ts` (created)
  - Business logic: create users (hash with `bcryptjs`), validate credentials, issue JWT.
- `backend/src/auth/dto/auth.dto.ts` (created)
  - DTOs + validation rules for signup/login requests.
- `backend/src/auth/strategies/jwt.strategy.ts` (created)
  - Verifies JWTs using `passport-jwt` and `@nestjs/jwt`.
- `backend/src/auth/guards/jwt-auth.guard.ts` (created)
  - Guard to protect routes using the `jwt` strategy.

#### Configuration & Dependencies
- `backend/package.json` (updated)
  - Added: `@nestjs/config`, `@nestjs/jwt`, `@nestjs/passport`, `passport`, `passport-jwt`, `bcryptjs`, `class-validator`, `class-transformer`.
  - Added Prisma scripts: `prisma:generate`, `prisma:migrate`, `prisma:studio`.
- `backend/env.example` (updated)
  - Declares `DATABASE_URL`, `DIRECT_URL`, `JWT_SECRET`, optional `SUPABASE_URL`, `SUPABASE_KEY`.

### Database: Prisma + Supabase
- `backend/prisma/schema.prisma` (updated)
  - Added `directUrl = env("DIRECT_URL")` and uses `url = env("DATABASE_URL")`.
  - Models:
    - `User` — base account entity with role enum `Role` (`INDIVIDUAL` | `ORGANIZATION`).
    - `IndividualProfile` — 1:1 with `User` via `userId` (unique).
    - `OrganizationProfile` — 1:1 with `User` via `userId` (unique).
    - `Project` — organized by a `User` and has many volunteers.
    - `ProjectVolunteer` — M:N join between `User` and `Project` with composite id.
  - Relation fixes: foreign keys live on the required side (`Profile.user`), `User.individualProfile`/`organizationProfile` are optional and no longer declare `fields/references`.
- `backend/prisma/migrations/...` (created)
  - Generated by `prisma migrate dev` after schema validation.

### Docs
- `docs/DATABASE.md` (created)
  - Recommends Neon/Supabase, env setup, migration/start steps.
- `docs/ARCHITECTURE.md` (this file)

## Runtime Configuration
- `backend/.env` (not committed)
  - `DATABASE_URL` — used by Prisma Client for runtime queries.
    - For IPv4 networks with Supabase use the Transaction Pooler:
      `postgresql://postgres.<project-ref>:<ENCODED_PW>@aws-0-eu-central-1.pooler.supabase.com:6543/postgres?sslmode=require&pgbouncer=true`
  - `DIRECT_URL` — used by Prisma for migrations/schema ops.
    - Use the Session Pooler:
      `postgresql://postgres.<project-ref>:<ENCODED_PW>@aws-0-eu-central-1.pooler.supabase.com:5432/postgres?sslmode=require`
  - `JWT_SECRET` — strong random secret for signing JWTs.
  - Optional: `SUPABASE_URL`, `SUPABASE_KEY` (service role for server-side Supabase client if needed).

Notes:
- URL-encode special characters in passwords (`!` → `%21`, `+` → `%2B`).
- Prisma automatically uses `directUrl` for migrations and `url` for normal client usage.

## How Components Work Together

### Request flow (Frontend → Backend → DB)
1. Frontend sends JSON requests to the NestJS API.
   - Signup: `POST /auth/signup` with `{ email, password, role }`.
   - Login: `POST /auth/login` with `{ email, password }`.
2. `AuthController` receives requests and delegates to `AuthService`.
3. `AuthService`:
   - Hashes/compares passwords via `bcryptjs`.
   - Uses `PrismaService` (Prisma Client) to read/write `User` and Profile tables.
   - On successful login, issues a JWT using `@nestjs/jwt`.
4. Responses return JSON; login returns `{ access_token }`.
5. Frontend stores the JWT (e.g., in memory or secure storage) and sends it in the `Authorization: Bearer <token>` header for subsequent protected routes.
6. Protected routes use `JwtAuthGuard` + `JwtStrategy` to authenticate and authorize access before reaching business logic.

### Database Access
- Prisma Client reads `DATABASE_URL` to connect.
- For migrations (`prisma migrate`), Prisma uses `DIRECT_URL` to avoid issues with pgBouncer.
- Supabase hosts PostgreSQL; using poolers ensures IPv4 compatibility across networks and efficient connection usage.

## Frontend Integration Notes
- Base URL: point your frontend to the NestJS server (e.g., `http://localhost:3000`).
- Auth usage:
  - Signup/Login against `/auth` endpoints.
  - Save returned JWT and send as `Authorization: Bearer <token>`.
  - Handle 401 responses by redirecting to login.
- Recommended: centralize API client with interceptors for JWT injection and error handling.

## Development Commands
- Install deps (WSL):
  ```bash
  npm --prefix /home/ubuntu/EcoConnect/backend install
  ```
- Generate Prisma client:
  ```bash
  npm --prefix /home/ubuntu/EcoConnect/backend run prisma:generate
  ```
- Run migrations (uses DIRECT_URL automatically):
  ```bash
  npm --prefix /home/ubuntu/EcoConnect/backend run prisma:migrate -- --name <change>
  ```
- Start API (dev):
  ```bash
  npm --prefix /home/ubuntu/EcoConnect/backend run start:dev
  ```

## Next Steps
- **[env hardening]** Move secrets to a secure store per environment; ensure strong `JWT_SECRET`.
- **[auth features]** Add email verification, password reset, and refresh tokens.
- **[roles/permissions]** Implement route-level authorization by role (INDIVIDUAL vs ORGANIZATION).
- **[profiles API]** Create CRUD endpoints for `IndividualProfile` and `OrganizationProfile`.
- **[projects API]** Implement endpoints for `Project` creation, listing, and volunteering (`ProjectVolunteer`).
- **[validation & errors]** Add rich validation messages and error filters for consistent JSON error shapes.
- **[logging/metrics]** Integrate request logging and basic metrics.
- **[testing]** Add unit tests for services/strategies and e2e tests for auth flows.
- **[CI/CD]** Add lint/typecheck/test to CI; deploy backend (e.g., Fly.io/Render/Vercel) with Supabase.
- **[frontend wiring]** Hook frontend auth forms to `/auth/signup` and `/auth/login`; persist JWT; add protected routes.

If you want, I can extend this doc with sequence diagrams or add a high-level system diagram in `docs/`.
